---
import BaseLayout from '../layouts/BaseLayout.astro';
import Grid from '../components/Grid.astro';
import Briefcase from '../components/icons/Briefcase.astro';
import fs from 'node:fs';
import path from 'node:path';
import matter from 'gray-matter';
import { marked } from 'marked';

// Load portfolio project files
const portfolioDir = 'src/content/portfolio';
const projectFiles = fs.readdirSync(portfolioDir).filter((f: string) => f.endsWith('.md'));
const allProjects = projectFiles
  .map((file: string) => {
    const content = fs.readFileSync(path.join(portfolioDir, file), 'utf-8');
    const { data, content: body } = matter(content);
    return {
      ...data,
      body: marked(body),
    };
  })
  .sort((a: any, b: any) => (a.sortOrder || 0) - (b.sortOrder || 0));

const professionalProjects = allProjects.filter((p: any) => p.category === 'professional');
const personalProjects = allProjects.filter((p: any) => p.category === 'personal');

const columnNames = ['Name', 'Stack', 'Infrastructure', 'Description'];
const columnSizes = 'sm:grid-cols-[1fr_1fr_1fr_1fr]';
---

<BaseLayout title="portfolio">
  <Grid columnNames={columnNames}>
    <!-- Professional Projects Section -->
    <div class={`grid grid-cols-1 ${columnSizes} gap-4 border-t`}>
      <div class="col-span-1 sm:col-span-4 py-4 px-4 font-bold">
        <Briefcase class="w-4 h-4 inline mr-2" />
        Professional Projects
      </div>
    </div>
    {professionalProjects.map((project: any) => (
      <details id={`project-${project.sortOrder}`}>
        <summary class={`grid grid-cols-1 ${columnSizes} gap-4 hover:bg-gray-100 border-t cursor-pointer`}>
          <div class="py-2 px-4">
            <span class="flex items-center text-blue-600 hover:underline font-bold">
              <img
                src={project.logo}
                alt={project.name}
                width={project.logoWidth}
                height="24"
                class="mr-4 py-2 min-w-[75px] object-contain"
              />
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 flex-shrink-0 mt-0.5 chevron-right"><path d="m9 18 6-6-6-6"/></svg>
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 ml-2 flex-shrink-0 chevron-down hidden"><path d="m6 9 6 6 6-6"/></svg>
            </span>
            <div class="sm:hidden text-xs text-gray-500 mt-2 border-l-2 pl-2">
              Built with {project.stack}
            </div>
            <div class="sm:hidden text-xs text-gray-500 mt-2 border-l-2 pl-2">
              {project.description}
            </div>
          </div>
          <div class="p-4 hidden sm:block">{project.stack}</div>
          <div class="p-4 hidden sm:block">{project.infrastructure}</div>
          <div class="p-4 max-w-xs truncate hidden sm:block">{project.description}</div>
        </summary>
        <div class="bg-gray-50">
          <div class="grid grid-cols-1 sm:grid-cols-[minmax(0,300px)_2fr] xl:grid-cols-[1fr_2fr_1fr] gap-2">
            <div class="px-4 pt-4 pb-0 sm:py-2 flex flex-row sm:flex-col gap-4">
              <div class="h-fit w-1/2 sm:w-auto">
                {project.heroImage && (
                  <img
                    src={project.heroImage}
                    alt={project.name}
                    width="400"
                    height="240"
                    class="min-w-[75px] object-contain sm:mb-4"
                  />
                )}
              </div>
              <div class="flex-1 flex flex-col w-1/2 sm:w-auto">
                {project.websiteUrl && (
                  <p>
                    <a
                      href={project.isAccessible ? project.websiteUrl : undefined}
                      target={project.isAccessible ? "_blank" : undefined}
                      class={`font-bold break-all ${project.isAccessible ? 'text-blue-600 hover:underline' : ''}`}
                    >
                      {project.websiteUrl.replace('https://', '').replace('http://', '').replace('www.', '')}
                    </a>
                  </p>
                )}
                {project.codeIsPublic && project.githubUrl ? (
                  <p class="italic">
                    View the code on{' '}
                    <a href={project.githubUrl} target="_blank" class="text-blue-600 hover:underline">Github</a>
                  </p>
                ) : !project.codeIsPublic ? (
                  <p class="italic">Code is not public</p>
                ) : null}
                {!project.isAccessible && <p class="italic">No longer accessible</p>}
              </div>
            </div>
            <div class="px-4 py-2 prose prose-sm max-w-none prose-a:text-blue-600 prose-a:no-underline hover:prose-a:underline" set:html={project.body} />
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-[minmax(0,300px)_2fr] xl:grid-cols-[1fr_2fr_1fr] gap-2">
            <div></div>
            <div>
              <button
                class="flex items-center text-blue-600 hover:underline p-4 collapse-btn"
                data-target={`project-${project.sortOrder}`}
              >
                Collapse
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 ml-2 flex-shrink-0"><path d="m18 15-6-6-6 6"/></svg>
              </button>
            </div>
          </div>
        </div>
      </details>
    ))}

    <!-- Personal Projects Section -->
    <div class={`grid grid-cols-1 ${columnSizes} gap-4 border-t`}>
      <div class="col-span-1 sm:col-span-4 py-4 px-4 font-bold">
        <Briefcase class="w-4 h-4 inline mr-2" />
        Personal Projects
      </div>
    </div>
    {personalProjects.map((project: any) => (
      <details id={`project-${project.sortOrder}`}>
        <summary class={`grid grid-cols-1 ${columnSizes} gap-4 hover:bg-gray-100 border-t cursor-pointer`}>
          <div class="py-2 px-4">
            <span class="flex items-center text-blue-600 hover:underline font-bold">
              <img
                src={project.logo}
                alt={project.name}
                width={project.logoWidth}
                height="24"
                class="mr-4 py-2 min-w-[75px] object-contain"
              />
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 flex-shrink-0 mt-0.5 chevron-right"><path d="m9 18 6-6-6-6"/></svg>
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 ml-2 flex-shrink-0 chevron-down hidden"><path d="m6 9 6 6 6-6"/></svg>
            </span>
            <div class="sm:hidden text-xs text-gray-500 mt-2 border-l-2 pl-2">
              Built with {project.stack}
            </div>
            <div class="sm:hidden text-xs text-gray-500 mt-2 border-l-2 pl-2">
              {project.description}
            </div>
          </div>
          <div class="p-4 hidden sm:block">{project.stack}</div>
          <div class="p-4 hidden sm:block">{project.infrastructure}</div>
          <div class="p-4 max-w-xs truncate hidden sm:block">{project.description}</div>
        </summary>
        <div class="bg-gray-50">
          <div class="grid grid-cols-1 sm:grid-cols-[minmax(0,300px)_2fr] xl:grid-cols-[1fr_2fr_1fr] gap-2">
            <div class="px-4 pt-4 pb-0 sm:py-2 flex flex-row sm:flex-col gap-4">
              <div class="h-fit w-1/2 sm:w-auto">
                {project.heroImage && (
                  <img
                    src={project.heroImage}
                    alt={project.name}
                    width="400"
                    height="240"
                    class="min-w-[75px] object-contain sm:mb-4"
                  />
                )}
              </div>
              <div class="flex-1 flex flex-col w-1/2 sm:w-auto">
                {project.websiteUrl && (
                  <p>
                    <a
                      href={project.isAccessible ? project.websiteUrl : undefined}
                      target={project.isAccessible ? "_blank" : undefined}
                      class={`font-bold break-all ${project.isAccessible ? 'text-blue-600 hover:underline' : ''}`}
                    >
                      {project.websiteUrl.replace('https://', '').replace('http://', '').replace('www.', '')}
                    </a>
                  </p>
                )}
                {project.codeIsPublic && project.githubUrl ? (
                  <p class="italic">
                    View the code on{' '}
                    <a href={project.githubUrl} target="_blank" class="text-blue-600 hover:underline">Github</a>
                  </p>
                ) : !project.codeIsPublic ? (
                  <p class="italic">Code is not public</p>
                ) : null}
                {!project.isAccessible && <p class="italic">No longer accessible</p>}
              </div>
            </div>
            <div class="px-4 py-2 prose prose-sm max-w-none prose-a:text-blue-600 prose-a:no-underline hover:prose-a:underline" set:html={project.body} />
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-[minmax(0,300px)_2fr] xl:grid-cols-[1fr_2fr_1fr] gap-2">
            <div></div>
            <div>
              <button
                class="flex items-center text-blue-600 hover:underline p-4 collapse-btn"
                data-target={`project-${project.sortOrder}`}
              >
                Collapse
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 ml-2 flex-shrink-0"><path d="m18 15-6-6-6 6"/></svg>
              </button>
            </div>
          </div>
        </div>
      </details>
    ))}
  </Grid>
</BaseLayout>

<script>
  document.querySelectorAll('.collapse-btn').forEach((btn) => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const target = (btn as HTMLElement).dataset.target;
      if (target) {
        const details = document.getElementById(target) as HTMLDetailsElement;
        if (details) details.open = false;
      }
    });
  });
</script>
