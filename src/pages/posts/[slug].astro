---
import BlogPost from '../../layouts/BlogPost.astro';
import fs from 'node:fs';
import path from 'node:path';
import matter from 'gray-matter';
import { marked } from 'marked';

const renderer = new marked.Renderer();
renderer.link = ({ href, title, text }) => {
  const titleAttr = title ? ` title="${title}"` : '';
  return `<a href="${href}"${titleAttr} target="_blank" rel="noopener noreferrer">${text}</a>`;
};
renderer.image = ({ href, title, text }) => {
  const alt = text ? ` alt="${text}"` : '';
  if (title) {
    return `<figure><img src="${href}"${alt} /><figcaption>${title}</figcaption></figure>`;
  }
  return `<img src="${href}"${alt} />`;
};
marked.use({ renderer });

export function getStaticPaths() {
  const blogDir = 'src/content/blog';
  if (!fs.existsSync(blogDir)) return [];

  const blogFiles = fs.readdirSync(blogDir).filter((f: string) => f.endsWith('.md'));
  return blogFiles
    .map((file: string) => {
      const content = fs.readFileSync(path.join(blogDir, file), 'utf-8');
      const { data, content: body } = matter(content);
      if (data.draft) return null;
      return {
        params: { slug: data.slug },
        props: {
          title: data.title,
          published: data.published,
          excerpt: data.excerpt,
          tags: data.tags,
          body: marked(body),
        },
      };
    })
    .filter(Boolean);
}

const { title, published, excerpt, tags, body } = Astro.props;
---

<BlogPost title={title} published={published} excerpt={excerpt} tags={tags}>
  <div class="prose prose-sm max-w-none prose-a:text-blue-600 prose-a:no-underline hover:prose-a:underline" set:html={body} />
</BlogPost>
